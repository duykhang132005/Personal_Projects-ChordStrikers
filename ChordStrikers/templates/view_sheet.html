{% extends "index.html" %}

{% block title %}{{ song.title }} | ChordStrikers{% endblock %}

{% block content %}
<div class="container py-5 text-white">
  <h1 class="mb-3">{{ song.title }}</h1>
  <p class="mb-1"><strong>Artist:</strong> {{ song.artist }}</p>
  <p class="mb-4"><strong>Key:</strong> {{ song.song_key or '—' }}</p>

  <div class="mb-3">
    <a href="{{ url_for('creator.edit_song', song_id=song.id) }}" class="btn btn-primary">Edit</a>
    <a href="{{ url_for('main.explore') }}" class="btn btn-danger">Return</a>
  </div>

  <!-- Compact transpose controls -->
  <form id="transpose-form"
        method="get"
        action="{{ url_for('main.view_sheet', song_id=song.id) }}"
        class="transpose-form mb-4">
    <div class="transpose-controls">
      <button type="button"
              class="transpose-btn minus"
              aria-label="Transpose down one semitone"
              data-step="-1">←</button>

      <input id="steps"
             name="steps"
             type="text"
             inputmode="numeric"
             pattern="^-?\d{1,2}$"
             value="{{ transposition_steps or 0 }}"
             class="steps-input"
             aria-label="Semitone steps (−11 to +11)">

      <button type="button"
              class="transpose-btn plus"
              aria-label="Transpose up one semitone"
              data-step="1">→</button>

      <div class="prefer-toggle">
        <input type="radio" id="prefAuto" name="prefer" value=""
               {% if not prefer %}checked{% endif %}>
        <label for="prefAuto" title="Automatic accidentals">A</label>

        <input type="radio" id="prefSharp" name="prefer" value="sharp"
               {% if prefer == 'sharp' %}checked{% endif %}>
        <label for="prefSharp" title="Prefer sharps">♯</label>

        <input type="radio" id="prefFlat" name="prefer" value="flat"
               {% if prefer == 'flat' %}checked{% endif %}>
        <label for="prefFlat" title="Prefer flats">♭</label>
      </div>

      <button type="button"
              class="transpose-reset"
              aria-label="Reset transposition to 0">Reset</button>
    </div>
  </form>

  {% if lines %}
    <h4 class="mt-4">
      Chords and Lyrics
      {% if transposition_steps %}
        <small class="text-info">(Transposed {{ transposition_steps }} semitone{% if transposition_steps|abs != 1 %}s{% endif %}{% if prefer %}, {{ prefer }}{% endif %})</small>
      {% endif %}
    </h4>
    <div class="song-content">
      {% for line in lines %}
        {% if line.lyric == '' %}
          <div class="section-header">{{ line.chord|safe }}</div>
        {% else %}
          <div class="line-block">
            <div class="chord-line">{{ line.chord|safe }}</div>
            <div class="lyric-line">{{ line.lyric|safe }}</div>
          </div>
        {% endif %}
      {% endfor %}
    </div>
  {% else %}
    <p class="text-warning">No preview available — file could not be read.</p>
  {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
function updateColumnCount() {
  const container = document.querySelector('.song-content');
  if (!container) return;

  const lines = [...container.querySelectorAll('.line-block, .section-header')];
  if (!lines.length) return;

  const longestLineLength = Math.max(...lines.map(l => {
    const chord = l.querySelector('.chord-line')?.textContent.length || 0;
    const lyric = l.querySelector('.lyric-line')?.textContent.length || 0;
    return Math.max(chord + 5, lyric + 5);
  }));

  const testSpan = document.createElement('span');
  testSpan.textContent = 'M';
  testSpan.style.visibility = 'hidden';
  container.appendChild(testSpan);
  const charWidth = testSpan.getBoundingClientRect().width;
  container.removeChild(testSpan);

  const containerWidth = container.getBoundingClientRect().width;
  const desiredColWidth = longestLineLength * charWidth;

  const MAX_COLS = 3;
  let colCount = Math.max(1, Math.min(MAX_COLS, Math.floor(containerWidth / desiredColWidth)));

  const contentHeight = container.scrollHeight;
  const visibleHeight = window.innerHeight;
  if (contentHeight <= visibleHeight) {
    colCount = 1;
  }
  container.style.columnCount = colCount;
}

window.addEventListener('load', updateColumnCount);
window.addEventListener('resize', updateColumnCount);
</script>

<script>
(function () {
  const form  = document.getElementById('transpose-form');
  const steps = document.getElementById('steps');
  const clamp = v => Math.max(-11, Math.min(11, v));

  document.querySelectorAll('.transpose-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const delta = parseInt(btn.dataset.step, 10);
      const current = parseInt(steps.value.trim(), 10) || 0;
      const next = clamp(current + delta);
      steps.value = next;
      form.submit();
    });
  });

  document.querySelectorAll('.prefer-toggle input').forEach(r => {
    r.addEventListener('change', () => form.submit());
  });

  steps.addEventListener('change', () => {
    const raw = steps.value.trim();
    const parsed = parseInt(raw, 10);
    if (!isNaN(parsed)) {
      steps.value = clamp(parsed);
    } else {
      steps.value = 0;
    }
    form.submit();
  });

  document.querySelector('.transpose-reset').addEventListener('click', () => {
    steps.value = 0;
    form.submit();
  });
})();
</script>

<style>
</style>
{% endblock %}